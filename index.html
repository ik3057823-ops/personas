<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fire Emergency ‚Äî Scenario Game</title>
  <style>
    :root{
      --bg:#0f172a; /* keep white background */
      --ink:#0b1324;
      --muted:#51607a;
      --primary:#2563eb;
      --accent:#10b981;
      --warn:#ef4444;
      --card:#f8fafc;
      --border:#e2e8f0;
      --shadow:0 12px 40px rgba(2,6,23,.10);
      --radius:18px;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";background-image:linear-gradient(180deg,rgba(10,15,30,.70),rgba(10,15,30,.55)), url('https://raw.githubusercontent.com/ik3057823-ops/images-5/refs/heads/main/fire%202.png');background-size:cover;background-position:center;background-attachment:fixed}
    .wrap{max-width:1100px;margin:0 auto;padding:32px 16px 64px}

    /* --- HUD ------------------------------------------------------------- */
    .hud{position:sticky;top:0;z-index:5;background-image:linear-gradient(180deg,rgba(10,15,30,.70),rgba(10,15,30,.40)), url('https://raw.githubusercontent.com/ik3057823-ops/images-5/refs/heads/main/fire%202.png');background-size:cover;background-position:center;border-bottom:1px solid var(--border)}
    .hud-inner{display:flex;flex-direction:column;align-items:center;gap:10px;padding:16px 6px;text-align:center}
    .brand{display:flex;flex-direction:column;align-items:center;gap:8px}
    .logo{display:none}
    h1{margin:0;font-size:clamp(20px,2.4vw,28px);letter-spacing:.2px;text-align:center;color:#ffffff}
    .subhead{color:#ffffff;font-size:14px;margin-top:2px;text-align:center}

    .stats{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap}
    .chip{display:flex;align-items:center;gap:8px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 12px;font-size:14px;box-shadow:0 1px 0 rgba(2,6,23,.04)}
    .toggle{cursor:pointer}

    .track{height:10px;background:#eef2f7;border-radius:99px;border:1px solid var(--border);overflow:hidden;max-width:760px;margin:6px auto 0}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#6366f1,#22d3ee);transition:width .5s cubic-bezier(.22,.61,.36,1)}

    /* --- BOARD ----------------------------------------------------------- */
    .board{margin-top:18px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    /* Pixel style just for the question board */
    .board.card{border:4px solid #0b1324;border-radius:0;box-shadow:0 8px 0 #0b1324, 0 12px 24px rgba(2,6,23,.25)}
    .card-head{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px 14px;background:#ffffff;border-bottom:1px solid var(--border);box-shadow:0 1px 8px rgba(2,6,23,.05)}
    /* Pixel vibe for question header text */
    #board .card-head h2, #board .card-head .subhead{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
    .card-body{padding:16px}

    /* --- COVER ----------------------------------------------------------- */
    .cover{display:grid;gap:14px;align-content:start}
    .cover h2{margin:0;font-size:22px}
    .cover ul{margin:0 0 6px 18px}

    /* --- QUESTION -------------------------------------------------------- */
    .prompt{font-size:22px;font-weight:800;margin:0 0 8px}
    .context{color:var(--muted);margin:0 0 16px}
    .options{display:grid;grid-template-columns:1fr;gap:12px;max-width:820px;margin:24px auto 0}
    .option{position:relative;display:flex;gap:10px;align-items:flex-start;border:3px solid #0b1324;background:#fff;border-radius:0;padding:12px 14px;text-align:left;cursor:pointer;transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease;box-shadow:0 4px 0 #0b1324}
    .option:active{transform:translateY(2px);box-shadow:0 2px 0 #0b1324}
    .option:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(2,6,23,.10)}
    .option[aria-pressed="true"]{outline:3px solid #bfdbfe;border-color:#93c5fd}
    .opt-k{flex:0 0 auto;width:32px;height:32px;border-radius:0;border:3px solid #0b1324;display:grid;place-items:center;font-weight:800;color:var(--muted);background:#f8fafc}

    .feedback{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid transparent;background:#fff;min-height:56px;visibility:hidden}
    .feedback.good{border-color:#d1fae5;box-shadow:0 0 0 3px #ecfdf5 inset}
    .feedback.bad{border-color:#fee2e2;box-shadow:0 0 0 3px #fff1f2 inset}
    .feedback.show{visibility:visible}
    .feedback.good{border-color:#d1fae5;box-shadow:0 0 0 3px #ecfdf5 inset}
    .feedback.bad{border-color:#fee2e2;box-shadow:0 0 0 3px #fff1f2 inset}

    .controls{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:14px 18px;border-top:1px solid var(--border);background:#fff}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:0 1px 0 rgba(2,6,23,.04)}
    .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
    /* Pixel buttons on question controls */
    #board .btn{border:3px solid #0b1324;border-radius:0;box-shadow:0 4px 0 #0b1324;background:#fff;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
    #board .btn.primary{background:#22d3ee}
    #board .btn:active{transform:translateY(2px);box-shadow:0 2px 0 #0b1324}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .hint{font-size:14px;color:var(--muted)}

    /* --- SUMMARY --------------------------------------------------------- */
    .summary{display:none; place-items:center; margin-top:0; min-height:calc(100vh - 0px); background-image:linear-gradient(180deg,rgba(10,15,30,.35),rgba(10,15,30,.55)), url('https://raw.githubusercontent.com/ik3057823-ops/images-5/refs/heads/main/fire%202.png'); background-size:cover; background-position:center; padding:32px 16px; color:#0b1324}
    .summary .wrap-inner{max-width:1100px;margin:0 auto}
    .glass{background:rgba(255,255,255,.95);backdrop-filter:saturate(140%) blur(2px);border:4px solid #0b1324;border-radius:0;box-shadow:0 8px 0 #0b1324, 0 12px 24px rgba(2,6,23,.25);padding:24px;image-rendering:pixelated}
    .score-hero{display:grid;gap:10px;text-align:center}
    .score-hero h2{margin:0;font-size:20px;letter-spacing:.5px;text-transform:uppercase;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .big-score{font-size:36px;font-weight:900;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .stats-row{display:flex;justify-content:center;gap:16px;flex-wrap:wrap;color:var(--muted)}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 12px;font-size:13px}

    /* --- Confetti -------------------------------------------------------- */
    .confetti{position:fixed;top:0;left:0;width:100%;height:0;pointer-events:none;overflow:visible}
    .particle{position:absolute;top:-10px;width:10px;height:14px;border-radius:2px;opacity:.9}

    /* --- Accessibility focus */
    :focus-visible{outline:3px solid #93c5fd;outline-offset:2px;border-radius:12px}

    /* --- Mentor speech bubble & typing --------------------------- */
    .mentor{display:flex;flex-direction:row-reverse;align-items:flex-start;gap:16px;justify-content:center;margin-bottom:24px}
    .mentor img{width:72px;height:72px;border-radius:0;border:1px solid var(--border);box-shadow:var(--shadow);background:#fff;object-fit:cover;image-rendering:pixelated}
    .bubble{position:relative;max-width:520px;background:#fff;border:4px solid #0b1324;border-radius:0;padding:10px 12px;box-shadow:0 6px 0 #0b1324, 0 12px 24px rgba(2,6,23,.18);text-align:left}
    .bubble:after{content:"";position:absolute;right:-14px;top:24px;width:18px;height:18px;background:#fff;border-right:4px solid #0b1324;border-top:4px solid #0b1324;transform:rotate(45deg)}
    .type{font-size:16px;line-height:1.5;min-height:56px;padding-left:12px}
    .caret{display:inline-block;width:10px;height:1.2em;vertical-align:bottom;background:currentColor;animation:blink 1s steps(1) infinite}
    @keyframes blink{50%{opacity:0}}

    /* hide legacy cover text elements */
    .cover p.context,.cover .hint{display:none}
    /* hide only the original static list under the bubble */
    .cover > ul{display:none}

    /* reveal animations for options */
    .option.hidden{opacity:0; transform:translateY(6px); pointer-events:none}
    @keyframes optionPop{0%{opacity:0; transform:translateY(6px) scale(.98)}100%{opacity:1; transform:translateY(0) scale(1)}}
      /* Ensure strong contrast for headings/subheads inside question/cover cards */
    .card-head h2{color:#0b1324}
    .card-head .subhead{color:#334155}

    /* Summary polish: smaller, cooler hero */
    .summary{display:none;margin-top:0;background-image:linear-gradient(180deg,rgba(10,15,30,.35),rgba(10,15,30,.55)), url('https://raw.githubusercontent.com/ik3057823-ops/images-5/refs/heads/main/fire%202.png');background-size:cover;background-position:center;padding:32px 16px;color:#0b1324}
    .summary .wrap-inner{max-width:760px;margin:0 auto}
    .glass{background:rgba(255,255,255,.92);backdrop-filter:saturate(130%) blur(6px);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.18);padding:20px}
    .score-hero h2{margin:0;font-size:22px}
    .big-score{font-size:32px;font-weight:900}
    .stats-row{display:flex;justify-content:center;gap:16px;flex-wrap:wrap;color:#475569}
      /* Pixel-style buttons on summary */
    .summary .btn{border:3px solid #0b1324;border-radius:0;box-shadow:0 4px 0 #0b1324;background:#fff;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
    .summary .btn.primary{background:#22d3ee}
    .summary .btn:active{transform:translateY(2px);box-shadow:0 2px 0 #0b1324}
      /* --- Pixel HUD & headings ----------------------------------------- */
    .brand h1, .brand .subhead{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
    .hud .chip{border:3px solid #0b1324;border-radius:0;box-shadow:0 4px 0 #0b1324;background:#fff;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
    .hud .chip:active{transform:translateY(2px);box-shadow:0 2px 0 #0b1324}

    /* --- Pixel cover/instructions ------------------------------------- */
    #cover.card{border:4px solid #0b1324;border-radius:0;box-shadow:0 8px 0 #0b1324, 0 12px 24px rgba(2,6,23,.25)}
    #cover .card-head h2, #cover .card-head .subhead{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}

    /* Global pixel buttons (cover, board, summary) */
    .btn{border:3px solid #0b1324;border-radius:0;box-shadow:0 4px 0 #0b1324;background:#fff;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
    .btn.primary{background:#22d3ee}
    .btn:active{transform:translateY(2px);box-shadow:0 2px 0 #0b1324}

    /* Pixel tables (for any present) */
    table{border:3px solid #0b1324;border-collapse:separate;border-spacing:0;background:#fff}
    th,td{border-top:3px solid #0b1324;border-right:3px solid #0b1324;padding:10px 12px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
    th:first-child,td:first-child{border-left:3px solid #0b1324}
    tr:last-child td{border-bottom:3px solid #0b1324}
      /* Pixel font for all question text */
    #board .type, #board .option, #board .opt-main, #board .opt-k{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
    #board .type{font-weight:700;letter-spacing:.3px}
      /* Pixel font for cover instructions and bullets */
    #cover .type, #cover .cover li, #cover .cover .btn, #cover .card-head h2 {font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
    #cover .type{font-weight:700;letter-spacing:.3px}
  </style>
</head>
<body>
  <div class="hud" role="navigation" aria-label="Game HUD">
    <div class="wrap hud-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Fire Emergency Quiz</h1>
          <div class="subhead">Make the safest decision under time pressure. Keyboard: 1/2/3 to choose.</div>
        </div>
      </div>
      <div class="stats" aria-live="polite" aria-atomic="true">
        <div class="chip"><strong>Question</strong> <span id="levelNow">0</span>/<span id="levelTotal">5</span></div>
        <div class="chip"><strong>Score</strong> <span id="score">0</span></div>
        <div class="chip" id="timerChip"><strong>Timer</strong> <span id="timer">00:30</span></div>
        <div class="chip toggle" id="soundToggle" role="button" aria-pressed="true" title="Toggle sounds">üîä Sound</div>
      </div>
      <div class="track" aria-label="Progress">
        <div class="bar" id="progress"></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- COVER SCREEN -->
    <section class="card" id="cover" aria-labelledby="coverTitle">
      <div class="card-head">
        <div>
          <h2 id="coverTitle" style="margin:0">Game Instructions</h2>
        </div>
      </div>
      <div class="card-body cover">
        <div class="mentor">
          <img src="https://raw.githubusercontent.com/ik3057823-ops/images-5/refs/heads/main/fire%205.png" alt="Trainer avatar giving instructions">
          <div class="bubble" aria-live="polite">
            <div id="typeTarget" class="type"></div>
          </div>
        </div>
        <!-- Hidden legacy static text (kept for accessibility/backup) -->
        <p class="context">You'll see realistic fire-emergency scenarios. For each <strong>Question</strong>, choose the safest action before the timer runs out.</p>
        <ul>
          <li>Use the number keys <strong>1/2/3</strong> or click to choose.</li>
          <li>Correct answers boost your <strong>Score</strong>; faster answers earn a time bonus.</li>
          <li>You can use <strong>Hint</strong> once per Question.</li>
          <li>At the end, download or print your summary report.</li>
        </ul>
        <p class="hint">UK context: Dial <strong>999</strong> (or <strong>112</strong>), never use lifts, attempt extinguishing only if trained and safe.</p>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
          <button class="btn primary" id="startBtn">Start Game</button>
        </div>
      </div>
    </section>

    <!-- QUESTION BOARD -->
    <section class="board card" id="board" aria-labelledby="questionTitle" style="display:none">
      <div class="card-head">
        <div>
          <h2 class="" id="questionTitle" style="margin:0;font-size:20px">Question 1</h2>
          <div class="subhead" id="goal" style="font-size:13px">Objective: choose the safest action</div>
        </div>
      </div>
      <div class="card-body" id="levelBody" style="min-height:clamp(320px,48vh,520px)"><!-- dynamic --></div>
      <div class="controls">
        <div class="left">
          <button class="btn" id="hintBtn">üí° Hint</button>
          <button class="btn" id="restartBtn">‚Üª Restart</button>
        </div>
        <div class="right">
          <button class="btn" id="backBtn">‚Üê Back</button>
          <button class="btn primary" id="nextBtn" disabled>Next ‚Üí</button>
        </div>
      </div>
    </section>

    <!-- SUMMARY (stylish hero; no per-question list) -->
    <section class="summary" id="summary" aria-live="polite">
      <div class="wrap wrap-inner">
        <div class="glass score-hero">
          <h2>Session Summary</h2>
          <div class="big-score" id="sumScore">Final Score: 0</div>
          <div class="stats-row">
            <div id="sumAcc">Accuracy: 0%</div>
            <div id="sumCorrect">0 / 0 correct</div>
            <div id="sumTime">Time: 00:00</div>
          </div>
          <div class="badges" id="badges"></div>
          <div style="display:flex;gap:10px;margin-top:12px;justify-content:center;flex-wrap:wrap">
            <button class="btn" id="quitBtn">Quit</button>
            <button class="btn primary" id="restartSummaryBtn">Restart</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="confetti" id="confetti"></div>

  <script>
    // --------------------------- DATA ---------------------------
    const SCENES = [
      { id:"intro", title:"Welcome", time:30, context:"You are working on the 3rd floor of a modern office in London. You notice a faint smell of smoke.", options:[
        {key:"1", text:"Ignore it; it will probably clear.", correct:false, consequence:"Delaying wastes precious seconds and can put others at risk."},
        {key:"2", text:"Check the nearest area safely (feel doors with the back of your hand), activate the alarm if needed, and notify others.", correct:true, consequence:"Correct. Investigate only if safe, and raise the alarm early."},
        {key:"3", text:"Take the lift to see if other floors are affected.", correct:false, consequence:"Never use lifts in a suspected fire. Use stairs."}
      ], guidance:"R.A.C.E.: Rescue (if safe), Alarm, Contain (close doors), Evacuate." },
      { id:"bin-fire", title:"Small Fire Found", time:35, context:"In the copy room you see a small waste‚Äëpaper bin fire. A water and a CO‚ÇÇ extinguisher are nearby. You are extinguisher-trained and the exit is clear.", options:[
        {key:"1", text:"Use the CO‚ÇÇ extinguisher from ~2m, sweeping at the base.", correct:false, consequence:"CO‚ÇÇ is primarily for electrical fires; it can blow light paper around, worsening a paper fire."},
        {key:"2", text:"Use the water extinguisher at the base of the flames, with your back to the exit; stop if it spreads.", correct:true, consequence:"Correct for ordinary combustibles (Class A). Keep a clear exit and stop if not immediately controlled."},
        {key:"3", text:"Close the door and walk away without raising the alarm.", correct:false, consequence:"Always raise the alarm and do not leave a fire unattended."}
      ], guidance:"PASS: Pull, Aim, Squeeze, Sweep. Only attempt if trained, the fire is small, the right type of extinguisher is available, and your exit is clear." },
      { id:"evac-route", title:"Evacuation Route", time:30, context:"The corridor is moderately smoky on your planned route to the stairs.", options:[
        {key:"1", text:"Proceed standing upright at normal pace to avoid panic.", correct:false, consequence:"Smoke rises; staying low reduces inhalation and improves visibility."},
        {key:"2", text:"Stay low/crawl if needed, close doors behind you, and head to an alternative stairwell if the first is blocked.", correct:true, consequence:"Correct actions: stay low, choose a safe alternate route, and close doors to slow fire spread."},
        {key:"3", text:"Wait for the lift; it will be faster to clear the building.", correct:false, consequence:"Never use lifts during a fire."}
      ], guidance:"Do not use lifts. Close doors as you go. Follow illuminated exit signage and assembly instructions." },
      { id:"assist-colleague", title:"Assisting a Colleague", time:35, context:"A colleague using a wheelchair is at the refuge point. An evacuation chair is nearby, and the Fire Warden is present.", options:[
        {key:"1", text:"Coordinate with the Fire Warden to deploy the evac chair, following your training and building procedure.", correct:true, consequence:"Correct. Follow your training and the Warden's lead; use designated equipment and refuge points."},
        {key:"2", text:"Carry them down the stairs with two volunteers to save time.", correct:false, consequence:"Unsafe for everyone; use proper equipment and trained personnel."},
        {key:"3", text:"Leave them at the refuge point and continue without informing anyone.", correct:false, consequence:"Always inform the Fire Warden/response team; refuge points must be monitored and assisted."}
      ], guidance:"Follow the building's Personal Emergency Evacuation Plans (PEEPs) and use refuges and evac chairs per training." },
      { id:"assembly", title:"Assembly & Reporting", time:30, context:"You reach the assembly point outside. Some colleagues want to re‚Äëenter to collect belongings.", options:[
        {key:"1", text:"Do not re‚Äëenter. Account for your team, report anyone missing to the Fire Warden, and be ready to brief the Fire Service (dial 999/112).", correct:true, consequence:"Correct. Accountability and communication speed up the response and keep everyone safe."},
        {key:"2", text:"Go back in quickly for your laptop; it will just take a minute.", correct:false, consequence:"Never re‚Äëenter until the building is declared safe by the Fire Service."},
        {key:"3", text:"Disperse; the Fire Service will contact people if needed.", correct:false, consequence:"Stay at the assembly point for roll call and information."}
      ], guidance:"UK: call 999 (or 112). Await the all‚Äëclear from incident command before re‚Äëentry." },
    ];

    // --------------------------- STATE ---------------------------
    let started = false;
    let idx = 0, score = 0;
    let perSceneTime = SCENES[0].time, timeLeft = perSceneTime, timerHandle = null;
    const decisions = []; // {id,title,choice,consequence,correct}
    let startTs = Date.now();
    let soundsOn = true;

    // --------------------------- ELEMENTS ---------------------------
    const cover = document.getElementById('cover');
    const startBtn = document.getElementById('startBtn');

    const board = document.getElementById('board');
    const levelBody = document.getElementById('levelBody');
    const nextBtn = document.getElementById('nextBtn');
    const backBtn = document.getElementById('backBtn');
    const restartBtn = document.getElementById('restartBtn');
    const hintBtn = document.getElementById('hintBtn');
    const timerEl = document.getElementById('timer');
    const progress = document.getElementById('progress');
    const scoreEl = document.getElementById('score');
    const levelNow = document.getElementById('levelNow');
    const levelTotal = document.getElementById('levelTotal');
    const questionTitle = document.getElementById('questionTitle');
    const goalEl = document.getElementById('goal');
    const soundToggle = document.getElementById('soundToggle');

    const summaryEl = document.getElementById('summary');
    const badgesEl = document.getElementById('badges');
    const quitBtn = document.getElementById('quitBtn');
    const restartSummaryBtn = document.getElementById('restartSummaryBtn');

    levelTotal.textContent = SCENES.length;

    // --------------------------- AUDIO ---------------------------
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    function beep(freq=600, dur=120, type='sine', vol=.15){
      if(!soundsOn) return;
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = vol;
      o.connect(g).connect(ctx.destination); o.start(); setTimeout(()=>{o.stop();}, dur);
    }

    // --------------------------- CONFETTI ------------------------
    const confetti = document.getElementById('confetti');
    function burst(){
      for(let i=0;i<18;i++){
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random()*100 + '%';
        p.style.background = `hsl(${Math.random()*360},90%,60%)`;
        const rot = (Math.random()*720-360)|0;
        p.animate([{transform:`translateY(0) rotate(0deg)`},{transform:`translateY(${window.innerHeight}px) rotate(${rot}deg)`}],{ duration: 1000 + Math.random()*500, easing:'cubic-bezier(.22,.61,.36,1)' });
        confetti.appendChild(p); setTimeout(()=>p.remove(), 1600);
      }
    }

    // --------------------------- RENDER --------------------------
    function render(){
      summaryEl.style.display = 'none';
      const s = SCENES[idx];
      perSceneTime = s.time;
      timeLeft = perSceneTime;
      updateTimer();
      startTimer();

      levelNow.textContent = idx+1;
      questionTitle.textContent = `Question ${idx+1}`;
      goalEl.textContent = ''; goalEl.style.display='none';
      progress.style.width = `${Math.round(idx/SCENES.length*100)}%`;
      backBtn.disabled = idx===0; nextBtn.disabled = true; hintBtn.disabled = false;

      levelBody.innerHTML = `
        <div class="mentor">
          <img src="https://raw.githubusercontent.com/ik3057823-ops/images-5/refs/heads/main/fire%205.png" alt="Trainer avatar giving instructions">
          <div class="bubble" aria-live="polite">
            <div id="qTypeTarget" class="type"></div>
          </div>
        </div>
        <div class="options" role="group" aria-label="Choices">
          ${s.options.map(o=>`
            <button class="option" data-key="${o.key}" aria-pressed="false">
              <span class="opt-k">${o.key}</span>
              <div class="opt-main"><strong>${o.text}</strong></div>
            </button>
          `).join('')}
        </div>
        <div id="feedback" class="feedback" role="status" aria-live="polite"></div>
      `;

      levelBody.querySelectorAll('.option').forEach(btn=>btn.addEventListener('click',()=>select(btn.dataset.key)));

      // Animated typing for the question context then reveal options sequentially
      const optionButtons = levelBody.querySelectorAll('.option');
      optionButtons.forEach(b=>b.classList.add('hidden'));
      typeText('qTypeTarget', s.context, 18, () => revealOptions(optionButtons));
    }

    // --------------------------- TIMER --------------------------
    function startTimer(){
      stopTimer();
      timerHandle = setInterval(()=>{
        timeLeft--;
        if(timeLeft === 10){ beep(1000,200,'square'); }
        updateTimer();
        if(timeLeft<=0){ timeOut(); }
      },1000);
    }
    function stopTimer(){ if(timerHandle) { clearInterval(timerHandle); timerHandle=null; } }
    function updateTimer(){
      const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
      const s = (timeLeft%60).toString().padStart(2,'0');
      timerEl.textContent = `${m}:${s}`;
    }

    // --------------------------- SCORING -------------------------
    function addScore(base){
      const bonus = timeLeft>perSceneTime/2 ? 25 : 0;
      const delta = base + bonus;
      score += delta;
      scoreEl.textContent = score;
      return {delta, bonus};
    }

    // --------------------------- SELECT -------------------------
    function select(key){
      const s = SCENES[idx];
      const choice = s.options.find(o=>o.key===key);
      if(!choice) return;

      levelBody.querySelectorAll('.option').forEach(b=>b.setAttribute('aria-pressed','false'));
      const current = levelBody.querySelector(`.option[data-key="${key}"]`);
      current.setAttribute('aria-pressed','true');

      const fb = document.getElementById('feedback');
      if(choice.correct){
        const {delta,bonus} = addScore(100); beep(800,140,'triangle');
        fb.className = 'feedback good show';
        fb.innerHTML = `<div><strong>Correct.</strong> +${delta} points${bonus?` (includes ${bonus} time bonus)`:''}. ${choice.consequence}</div>`;
        burst();
      } else {
        beep(220,160,'sawtooth');
        fb.className = 'feedback bad show';
        fb.innerHTML = `<div><strong>Not the safest option.</strong> ${choice.consequence}</div>`;
      }

      const rec = { id:s.id, title:s.title, choice:`${choice.key}: ${choice.text}`, consequence:choice.consequence, correct:choice.correct };
      const i = decisions.findIndex(d=>d.id===s.id);
      if(i>=0) decisions.splice(i,1,rec); else decisions.push(rec);

      nextBtn.disabled = false;
      stopTimer();
    }

    // --------------------------- TIMEOUT ------------------------
    function timeOut(){
      beep(180,240,'square');
      const fb = document.getElementById('feedback');
      fb.className = 'feedback bad'; fb.style.display='block';
      fb.innerHTML = `<div><strong>Time up!</strong> Consider using a hint next time. You can still proceed.</div>`;
      nextBtn.disabled = false; stopTimer();
    }

    // --------------------------- NAV ----------------------------
    function next(){ if(idx<SCENES.length-1){ idx++; render(); } else { finish(); } }
    function back(){ if(idx>0){ idx--; render(); } }

    // --------------------------- FINISH -------------------------
    function finish(){
      stopTimer();
      progress.style.width='100%';
      // Compute summary stats (no per-question listing)
      const total = SCENES.length;
      const totalCorrect = decisions.filter(d=>d.correct).length;
      const accuracy = Math.round((totalCorrect/total)*100);
      const secs = Math.max(1, Math.floor((Date.now()-startTs)/1000));
      const mm = String(Math.floor(secs/60)).padStart(2,'0');
      const ss = String(secs%60).padStart(2,'0');

      // Update summary hero values
      document.getElementById('sumScore').textContent = `Final Score: ${score}`;
      document.getElementById('sumAcc').textContent = `Accuracy: ${accuracy}%`;
      document.getElementById('sumCorrect').textContent = `${totalCorrect} / ${total} correct`;
      document.getElementById('sumTime').textContent = `Time: ${mm}:${ss}`;

      // Show summary as a new page (hide HUD and board)
      const hud = document.querySelector('.hud');
      if(hud) hud.style.display='none';
      cover.style.display='none';
      board.style.display='none';
      summaryEl.style.display='grid';
      window.scrollTo({top:0, behavior:'instant'});

      // Badges
      badgesEl.innerHTML = '';
      makeBadge(`üèÅ Final Score: ${score}`);
      if(totalCorrect===total) makeBadge('üåü Perfect Safety');

      // Bind summary controls
      quitBtn.onclick = closePage;
      restartSummaryBtn.onclick = ()=>{ restart(); startGame(); };
    }

    function makeBadge(text){ const b=document.createElement('div'); b.className='badge'; b.textContent=text; badgesEl.appendChild(b); }

    function restart(){ started=false; idx=0; score=0; decisions.length=0; scoreEl.textContent=0; showCover(); }

    // Hint (once per question)
    hintBtn.addEventListener('click',()=>{
      const s = SCENES[idx];
      const ok = s.options.find(o=>o.correct);
      const el = levelBody.querySelector(`.option[data-key="${ok.key}"]`);
      el.animate([{boxShadow:'0 0 0 0 rgba(34,197,94,0)'},{boxShadow:'0 0 0 8px rgba(34,197,94,.35)'}],{duration:600, direction:'alternate', iterations:2, easing:'ease-out'});
      beep(700,120,'sine');
      hintBtn.disabled = true;
    });

    // Keyboard shortcuts: 1/2/3 select, Enter = Next
    document.addEventListener('keydown', (e)=>{
      if(!started) return; 
      if(['1','2','3'].includes(e.key)){
        const btn = levelBody.querySelector(`.option[data-key="${e.key}"]`); if(btn) btn.click();
      } else if(e.key==='Enter' && !nextBtn.disabled){ next(); }
    });

    // Buttons
    nextBtn.addEventListener('click', next);
    backBtn.addEventListener('click', back);
    restartBtn.addEventListener('click', restart);

    function closePage(){
      // Attempt to close the tab/window. If blocked, fall back to blanking the page.
      try{ window.open('', '_self'); window.close(); }catch(e){}
      // Fallback for browsers that prevent close()
      location.href = 'about:blank';
    }

    function quitToCover(){
      started = false;
      idx = 0; score = 0; decisions.length = 0; scoreEl.textContent = 0;
      showCover();
    }

    // Sound toggle
    soundToggle.addEventListener('click',()=>{ soundsOn = !soundsOn; soundToggle.setAttribute('aria-pressed', String(soundsOn)); soundToggle.textContent = (soundsOn? 'üîä Sound' : 'üîá Sound'); });

    // COVER helpers
    function showCover(){
      const hud = document.querySelector('.hud');
      if(hud) hud.style.display='block';
      cover.style.display='block';
      board.style.display='none';
      summaryEl.style.display='none';
      document.getElementById('levelNow').textContent = 0;
      progress.style.width='0%';
      const tc = document.getElementById('timerChip'); if(tc) tc.style.display='none';
      const lines = [
        "You'll see realistic fire‚Äëemergency scenarios.",
        "For each Question, choose the safest action before the timer runs out.",
        "Use number keys 1/2/3 or click; you can use Hint once per Question.",
        "Faster correct answers earn a small time bonus.",
        "When you finish, you can quit or restart."
      ];
      typeList('typeTarget', lines, 22, 80);
    }
    function startGame(){
      // resume audio context on first user gesture if needed
      if(ctx.state === 'suspended'){ ctx.resume(); }
      const tc = document.getElementById('timerChip'); if(tc) tc.style.display='';
      started = true; cover.style.display='none'; board.style.display='grid';
      startTs = Date.now(); idx=0; render();
    }

    startBtn.addEventListener('click', startGame);

    // --------------------------- TYPING --------------------------
    function typeList(targetId, lines, speed=24, gap=320){
      const host = document.getElementById(targetId);
      if(!host) return;
      host.innerHTML = "<ul class='type' id='"+targetId+"_list'></ul>";
      const list = document.getElementById(targetId+"_list");
      let i=0, j=0; let li=null; let caret=null;
      function newItem(){
        li = document.createElement('li');
        list.appendChild(li);
        caret = document.createElement('span');
        caret.className = 'caret';
        caret.textContent = ' ';
        li.appendChild(caret);
      }
      newItem();
      function next(){
        if(i >= lines.length){ if(caret) caret.remove(); return; }
        const line = lines[i];
        if(j < line.length){
          caret.insertAdjacentText('beforebegin', line[j++]);
          setTimeout(next, speed);
        } else {
          if(caret) caret.remove();
          i++; j=0;
          if(i < lines.length){ newItem(); setTimeout(next, gap); }
        }
      }
      next();
    }

    function typeText(targetId, text, speed=18, done){
      const host = document.getElementById(targetId);
      if(!host){ if(done) done(); return; }
      host.textContent = '';
      const caret = document.createElement('span');
      caret.className = 'caret'; caret.textContent = ' ';
      host.appendChild(caret);
      let i=0;
      (function next(){
        if(i >= text.length){ caret.remove(); if(done) done(); return; }
        caret.insertAdjacentText('beforebegin', text[i++]);
        setTimeout(next, speed);
      })();
    }

    function revealOptions(nodeList){
      const nodes = Array.from(nodeList);
      nodes.forEach((btn, idx)=>{
        setTimeout(()=>{
          btn.classList.remove('hidden');
          btn.style.animation = 'optionPop 260ms cubic-bezier(.22,.61,.36,1) both';
          btn.style.pointerEvents = '';
        }, 160*idx);
      });
    }

    // --------------------------- QUICK TESTS ---------------------
    (function quickTests(){
      try{
        // Test 1: typeText writes and calls done
        const t = document.createElement('div'); t.id='__testType'; document.body.appendChild(t);
        let doneCalled = false;
        typeText('__testType','ABC',0,()=>{doneCalled=true;});
        setTimeout(()=>{
          console.assert(doneCalled, 'typeText: done() not called');
          console.assert(t.textContent.trim().startsWith('ABC'), 'typeText: content mismatch');
          t.remove();
        }, 10);

        // Test 2: typeList creates correct number of items
        const l = document.createElement('div'); l.id='__testList'; document.body.appendChild(l);
        typeList('__testList',['One','Two'],0,0);
        setTimeout(()=>{
          const ul = l.querySelector('ul');
          console.assert(ul && ul.children.length===2, 'typeList: list items incorrect');
          l.remove();
        }, 5);

        // Test 3: initial cover visible
        console.assert(getComputedStyle(cover).display !== 'none', 'Cover should be visible initially');

        // Test 4: render() creates three options for first scene
        render();
        setTimeout(()=>{
          const opts = document.querySelectorAll('#levelBody .option');
          console.assert(opts.length===3, 'render: expected 3 options');
          // Reset to cover for users
          quitToCover();
        }, 20);
      }catch(e){ console.warn('Quick tests error (non-fatal):', e); }
    })();

    // INIT
    showCover();
  </script>
</body>
</html>
